<div class="row mx-auto animated fadeIn fast">
	<div class="col-xl-6 col-12">
		<div class="card">
			<div class="card-header" [ngClass]="{'bg-primary': !isEdit, 'bg-warning': isEdit}">
				<h5	class="card-title" [ngClass]="{'text-white': !isEdit, 'text-dark': isEdit}">
					<fa-icon *ngIf="!isEdit" [icon]="faPlus"></fa-icon>
					<fa-icon *ngIf="isEdit" [icon]="faPen"></fa-icon>
					{{ isEdit ? 'Editando compra ' + purchase.reference_number : 'Nueva compra'}}
				</h5>
			</div>
			<div *ngIf="secondPart" class="card-header" ngClass="bg-primary">
				<h3 class="card-title" ngClass="text-white">Nuevo Producto</h3>
			</div>
			<div class="card-body">
				<form
					[ngbCollapse]="secondPart"
					autocomplete="off"
					[formGroup]="purchaseForm"
					id="ngPurchaseForm"
					(ngSubmit)="submitPurchaseForm()"
				>
					<div class="row">
						<div class="col-12">
							<!-- Proveedor -->
							<div class="mb-3">
								<label for="provider-id" class="form-label">Proveedor *</label>
								<ng-select
									formControlName="provider_id"
									id="provider-id"
									class="custom-select"
									[class.is-invalid]="isInValid('provider_id')"
								>
									<ng-option [value]="0" disabled
										>Seleccione un proveedor</ng-option
									>
									<ng-option
										*ngFor="let provider of providers"
										[value]="provider.id"
										>{{provider.name}}</ng-option
									>
								</ng-select>
								<div class="invalid-feedback">
									Por favor, seleccionar un proveedor
								</div>
							</div>
							<!-- Numero de Referencia -->
							<div class="mb-3">
								<label for="reference_number" class="form-label"
									>Numero de referencia *</label
								>
								<input
									type="text"
									id="reference_number"
									class="form-control"
									formControlName="reference_number"
									placeholder="Numero de referencia"
									[class.is-invalid]="isInValid('reference_number')"
								/>

								<div class="invalid-feedback">
									Por favor, ingresar el numero de referencia
								</div>
							</div>
							<!-- Fecha -->
							<div class="mb-3">
								<label for="date" class="form-label">Fecha *</label>
								<div class="input-group">
									<input
										class="form-control"
										id="date"
										[value]="this.purchase.date"
										placeholder="dd/mm/aaaa"
										formControlName="date"
										[class.is-invalid]="isInValid('date')"
									/>
									<div class="input-group-append">
										<input
											#d="ngbDatepicker"
											ngbDatepicker
											hidden
											placement="right"
											[positionTarget]="pop"
											hidden
											(dateSelect)="setDatePurchase($event)"
										/>
										<button
											class="btn btn-outline-info calendar"
											(click)="d.toggle() "
											type="button"
											#pop
										>
											<fa-icon [icon]="faCalendarAlt"></fa-icon>
										</button>
									</div>
									<div class="invalid-feedback">
										Por favor, ingresar la fecha de la compra
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- /.row -->
				</form>
				<form
					[ngbCollapse]="!secondPart"
					autocomplete="off"
					[formGroup]="productForm"
					id="ngProductForm"
					(ngSubmit)="submitProductForm()"
				>
					<div class="row">
						<div class="col-12">
							<div class="mb-3">
								<label for="product-id" class="form-label">Producto *</label>
								<ng-select
									formControlName="product_id"
									id="product-id"
									class="custom-select"
									[class.is-invalid]="invalidProductForm('product_id')"
								>
									<ng-option [value]="0" disabled
										>Seleccione un producto</ng-option
									>
									<ng-option
										*ngFor="let product of producstList"
										[value]="product.id"
										>{{product.name}}</ng-option
									>
								</ng-select>
								<div class="invalid-feedback">
									Por favor, seleccionar un producto
								</div>
							</div>
							<div class="mb-3">
								<label for="cost_price" class="form-label">Costo *</label>
								<input
									id="cost_price"
									type="number"
									class="form-control"
									[class.is-invalid]="invalidProductForm('cost_price')"
									formControlName="cost_price"
									placeholder="Precio de costo"
								/>
								<div class="invalid-feedback">Por favor, ingresar un costo</div>
							</div>
							<div class="mb-3">
								<label for="presentation" class="form-label"
									>Presentacion *</label
								>
								<input
									id="presentation"
									type="text"
									class="form-control"
									[class.is-invalid]="invalidProductForm('presentation')"
									formControlName="presentation"
									placeholder="Presentacion"
								/>
								<div class="invalid-feedback">
									Por favor, ingresar una presentacion
								</div>
							</div>
							<div class="mb-3">
								<label for="quantity" class="form-label">Cantidad *</label>
								<input
									id="quantity"
									type="number"
									class="form-control"
									[class.is-invalid]="invalidProductForm('quantity')"
									formControlName="quantity"
									placeholder="Cantidad"
								/>
								<div class="invalid-feedback">Por favor, ingresar cantidad</div>
							</div>
							<div class="mb-3">
								<label for="expiry_date" class="form-label"
									>Fecha de vencimiento
								</label>
								<div class="input-group">
									<input
										class="form-control"
										placeholder="dd/mm/aaaa"
										formControlName="expiry_date"
										ngbDatepicker
										#d2="ngbDatepicker"
										[placement]="'right'"
										[positionTarget]="pop1"
									/>
									<div class="input-group-append">
										<button
											class="btn btn-outline-info calendar"
											(click)="d2.toggle()"
											type="button"
											#pop1
										>
											<fa-icon [icon]="faCalendarAlt"></fa-icon>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- /.row -->
				</form>
			</div>
			<!-- Campo de Submit -->
			<div class="card-footer d-flex justify-content-between">
				<a class="btn btn-secondary btn-block mr-1" [routerLink]="['/compras']"
					>Volver</a
				>
				<button
					*ngIf="!secondPart"
					type="submit"
					class="btn btn-success btn-md btn-block mt-0"
					form="ngPurchaseForm"
					[disabled]="purchaseForm.invalid"
				>
					<fa-icon [icon]="isEdit || alreadyCreated? faSave : faPlus"></fa-icon>
					{{isEdit || alreadyCreated? 'Guardar' : 'Crear'}}
				</button>
				<button
					*ngIf="secondPart"
					type="submit"
					class="btn btn-success btn-md btn-block mt-0"
					form="ngProductForm"
					[disabled]="productForm.invalid"
				>
					<fa-icon [icon]="isEdit ? faSave : faPlus"></fa-icon> {{isEdit?
					'Cargar producto' : 'Cargar producto'}}
				</button>
			</div>
		</div>
	</div>
	<div class="col-xl-6 col-12">
		<div class="col-12" style="text-align: center">
			<fa-icon
				[icon]="faShoppingCart"
				size="10x"
				class="text-secondary"
				position="center"
			></fa-icon>
		</div>
		<button
			*ngIf="secondPart"
			class="btn btn-info btn-block mr-1"
			(click)="unCollapse()"
		>
			Editar valores de la compra
		</button>
		<div [ngbCollapse]="!secondPart" class="card">
			<div class="card-header">
				<div class="row">
					<div class="col-12">
						<h5
							*ngIf="secondPart"
							class="card-title"
							[ngClass]="{'text-info': !isEdit, 'text-dark': isEdit}"
						>
							<strong>Categoria:</strong>
						</h5>
						<label class="col-form-label text-dark"
							>{{purchase.provider_name}}</label
						>
						<h5
							*ngIf="secondPart"
							class="card-title"
							[ngClass]="{'text-info': !isEdit, 'text-dark': isEdit}"
						>
							<strong>Numero de referencia:</strong>
						</h5>
						<label class="col-form-label text-dark"
							>{{purchase.reference_number}}</label
						>
						<h5
							*ngIf="secondPart"
							class="card-title"
							[ngClass]="{'text-info': !isEdit, 'text-dark': isEdit}"
						>
							<strong>Fecha:</strong>
						</h5>
						<label class="col-form-label text-dark">{{purchase.date}}</label>
						<div
							class="h5 mb-0 mt-3"
							style="
								display: flex;
								vertical-align: center;
								justify-content: center;
							"
						>
							Buscar
						</div>
						<div
							class="row"
							style="
								display: flex;
								vertical-align: center;
								justify-content: center;
							"
						>
							<div class="col-10">
								<form
									[formGroup]="searchForm"
									id="ngSearchForm"
									(ngSubmit)="testingFilter()"
								>
									<div class="row mb-2">
										<div class="col-7">
											<label
												for="search"
												class="form-label"
												style="
													display: flex;
													vertical-align: center;
													justify-content: center;
												"
											>
												Valor <fa-icon [icon]="faSearch"></fa-icon
											></label>
											<input
												type="text"
												id="search"
												class="form-control"
												formControlName="search"
												placeholder="...."
											/>
										</div>
										<div class="col-5">
											<label
												for="field"
												class="form-label"
												style="
													display: flex;
													vertical-align: center;
													justify-content: center;
												"
												>Parametro</label
											>
											<ng-select
												formControlName="field"
												id="field"
												class="custom-select"
											>
												<ng-option
													*ngFor="let field of fields"
													[value]="field.eng"
													>{{field.esp}}</ng-option
												>
											</ng-select>
										</div>
									</div>
								</form>
							</div>
							<div class="col-1">
								<button
									type="submit"
									class="btn btn-success btn-md"
									form="ngSearchForm"
								>
									<fa-icon [icon]="faSearch"></fa-icon>
								</button>
								<button (click)="refreshList()" class="btn btn-info btn-md">
									<fa-icon [icon]="faRedo"></fa-icon>
								</button>
							</div>
						</div>
						<div
							class="row"
							style="
								display: flex;
								vertical-align: center;
								justify-content: center;
							"
						>
							<button (click)="receive()" class="btn btn-info btn-md">
								Recibida <fa-icon [icon]="faSave"></fa-icon>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<hr />

<div class="row" [ngbCollapse]="!secondPart">
	<div class="col">
		<div class="card">
			<div class="card-body">
				<form [formGroup]="arrayForm">
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<th scope="col">Producto</th>
								<th scope="col">Cant.</th>
								<th scope="col">Pres.</th>
								<th scope="col">Precio</th>
								<th scope="col">Total</th>
								<th scope="col">Vto.</th>
								<th scope="col">Acciones</th>
							</tr>
						</thead>
						<tbody formArrayName="purchasesProducts">
							<tr
								*ngFor="let row of purchasesProducts.controls,index as i"
								[formGroupName]="i"
							>
								<td class="col-3">
									<ng-select
										formControlName="product_id"
										id="product-id"
										class="custom-select"
									>
										<ng-option
											*ngFor="let product of producstList"
											[value]="product.id"
											>{{product.name}}</ng-option
										>
									</ng-select>
								</td>
								<td class="col-1">
									<input
										type="number"
										class="form-control form-control-sm"
										formControlName="quantity"
										[class.is-invalid]="invalidRow('quantity',i)"
									/>
									<div class="invalid-feedback">
										Por favor, ingresar una cantidad
									</div>
								</td>
								<td class="col-1">
									<input
										type="number"
										class="form-control form-control-sm"
										formControlName="presentation"
										[class.is-invalid]="invalidRow('presentation',i)"
									/>
									<div class="invalid-feedback">
										Por favor, ingresar una presentacion
									</div>
								</td>
								<td class="col-1">
									<input
										type="number"
										class="form-control form-control-sm"
										formControlName="cost_price"
										[class.is-invalid]="invalidRow('cost_price',i)"
									/>
									<div class="invalid-feedback">
										Por favor, ingresar un costo
									</div>
								</td>
								<td>
									<label
										>{{purchasesProducts.value[i].total_line | currency}}</label
									>
								</td>
								<td class="col-2">
									<div class="input-group">
										<input
											class="form-control"
											[id]="i"
											[value]="purchasesProducts.value[i].expiry_date.value"
											placeholder="dd/mm/aaaa"
											formControlName="expiry_date"
										/>
										<div class="input-group-append">
											<input
												#d="ngbDatepicker"
												ngbDatepicker
												hidden
												placement="center"
												[positionTarget]="pop"
												hidden
												(dateSelect)="setDateProductsOnList($event,i)"
											/>
											<button
												class="btn btn-outline-info calendar"
												(click)="d.toggle() "
												type="button"
												#pop
											>
												<fa-icon [icon]="faCalendarAlt"></fa-icon>
											</button>
										</div>
									</div>
								</td>
								<td>
									<div class="d-flex">
										<button
											type="submit"
											class="btn btn-sm btn-success ml-1 mr-1"
											(click)="updateProduct(i)"
											[disabled]="purchasesProducts.controls[i].invalid"
										>
											<fa-icon [icon]="faSave"></fa-icon>
										</button>
										<button
											class="btn btn-sm btn-danger ml-1 mr-1"
											(click)="deleteProduct(row.value.id, i)"
										>
											<fa-icon [icon]="faTrash"></fa-icon>
										</button>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</form>
			</div>
		</div>
	</div>
</div>
